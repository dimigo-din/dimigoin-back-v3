
name: Automatic Deploy Production

on:
  push:
    branches: [ production ]
    
jobs:
  build:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v2
      
    - name: remove old packageğŸ—‘ 
      run: pm2 delete 'dimigoin-backend-deploy'
      
    - name: remove old package file 
      run: rm -rf ~/build/circle.dimigo.in-backend

    - name: install package âœ”ï¸
      run: yarn
        
    - name: genarate target folder ğŸ—‚
      run: mkdir ~/build/circle.dimigo.in-backend
      
    - name: build typescript ğŸ“¦
      run: tsc
      
    - name: move pacakage ğŸ’
      run: mv * ~/build/circle.dimigo.in-backend
      
    - name: deploy packageğŸš€ 
      
      run: pm2 start 'node ~/build/circle.dimigo.in-backend/dist/index.js' --name dimigoin-backend-deploy
      
    - name: Slack Notification failed ğŸ™…
      if: failure()
      uses: rtCamp/action-slack-notify@v2.0.0
      env:
        SLACK_CHANNEL: build-notification
        SLACK_COLOR: '#FF0000'
        SLACK_ICON: http://github.com/dimigoin.png?size=48
        SLACK_MESSAGE: 'ë°±ì—”ë“œì— ëŒ€í•œ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆì–´ìš” ! :cry:'
        SLACK_TITLE: Deploy failed
        SLACK_USERNAME: Dimigoin auto deploy bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

    - name: Slack Notification success ğŸ™†
      if: success()
      uses: rtCamp/action-slack-notify@v2.0.0
      env:
        SLACK_CHANNEL: build-notification
        SLACK_COLOR: '#04ff00'
        SLACK_ICON: http://github.com/dimigoin.png?size=48
        SLACK_MESSAGE: 'ë°±ì—”ë“œì— ëŒ€í•œ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆì–´ìš” ! :rocket:'
        SLACK_TITLE: Deploy Success
        SLACK_USERNAME: Dimigoin auto deploy bot
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
